# ============================================================================
# Build & Publish Package Workflow
# ============================================================================
# Purpose: Build, verify, and publish package to npm and GitHub Packages
# Triggers: Push to main, Tags, PR, Manual dispatch
# Features: Multi-version matrix, caching, artifacts, auto-publish
# ============================================================================

name: Build & Publish

# ============================================================================
# CONFIGURATION SECTION - Easy to customize
# ============================================================================
env:
  # Package manager and Node.js versions
  PNPM_VERSION: 10.21.0
  NODE_VERSION_DEFAULT: '20'
  
  # Build configuration
  BUILD_OUTPUT_DIR: dist
  BUILD_TIMEOUT_MINUTES: 10
  
  # Artifact configuration
  ARTIFACT_RETENTION_DAYS: 7
  ARTIFACT_NAME_PREFIX: build-package
  
  # Publish configuration
  PUBLISH_ON_MAIN: true  # Auto-publish when pushing to main
  NPM_REGISTRY: 'https://registry.npmjs.org'
  GITHUB_REGISTRY: 'https://npm.pkg.github.com'

# ============================================================================
# TRIGGERS - When to run this workflow
# ============================================================================
on:
  # Trigger on push to branches and tags
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'fix/**'
    tags:
      - 'v*.*.*'

  # Trigger on pull requests
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'tsconfig*.json'

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      node-version:
        description: 'Node.js version to build with'
        required: false
        default: '20'
        type: choice
        options:
          - '20'
          - '22'
      skip-type-check:
        description: 'Skip TypeScript type checking'
        required: false
        default: false
        type: boolean
      upload-artifacts:
        description: 'Upload build artifacts'
        required: false
        default: true
        type: boolean
      publish:
        description: 'Publish to npm and GitHub Packages'
        required: false
        default: false
        type: boolean

  # Optional: Scheduled builds (uncomment to enable)
  # schedule:
  #   # Run every day at 2 AM UTC
  #   - cron: '0 2 * * *'

# ============================================================================
# PERMISSIONS - Required for publishing
# ============================================================================
permissions:
  contents: write        # Required for creating releases
  packages: write        # Required for GitHub Packages
  pull-requests: read
  id-token: write        # Required for npm provenance

# ============================================================================
# JOBS
# ============================================================================
jobs:
  # ==========================================================================
  # JOB 1: Setup and Validation
  # ==========================================================================
  setup:
    name: Setup & Validate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      node-versions: ${{ steps.config.outputs.node-versions }}
      skip-type-check: ${{ steps.config.outputs.skip-type-check }}
      upload-artifacts: ${{ steps.config.outputs.upload-artifacts }}
      should-publish: ${{ steps.config.outputs.should-publish }}
      package-version: ${{ steps.version.outputs.package-version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for version detection

      - name: Configure workflow
        id: config
        run: |
          # Determine Node.js versions to build
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            NODE_VERSIONS='["${{ github.event.inputs.node-version }}"]'
            SKIP_TYPE_CHECK="${{ github.event.inputs.skip-type-check }}"
            UPLOAD_ARTIFACTS="${{ github.event.inputs.upload-artifacts }}"
            SHOULD_PUBLISH="${{ github.event.inputs.publish }}"
          else
            # Default: Build with LTS versions (Node 18 has compatibility issues with jsdom@27)
            NODE_VERSIONS='["20", "22"]'
            SKIP_TYPE_CHECK="false"
            UPLOAD_ARTIFACTS="true"
            
            # Auto-publish logic
            if [ "${{ startsWith(github.ref, 'refs/tags/v') }}" == "true" ]; then
              # Tag push - always publish
              SHOULD_PUBLISH="true"
            elif [ "${{ github.ref }}" == "refs/heads/main" ] && [ "${{ env.PUBLISH_ON_MAIN }}" == "true" ]; then
              # Push to main - publish if enabled
              SHOULD_PUBLISH="true"
            else
              # PR or feature branch - don't publish
              SHOULD_PUBLISH="false"
            fi
          fi
          
          echo "node-versions=$NODE_VERSIONS" >> $GITHUB_OUTPUT
          echo "skip-type-check=$SKIP_TYPE_CHECK" >> $GITHUB_OUTPUT
          echo "upload-artifacts=$UPLOAD_ARTIFACTS" >> $GITHUB_OUTPUT
          echo "should-publish=$SHOULD_PUBLISH" >> $GITHUB_OUTPUT
          
          echo "üì¶ Build configuration:"
          echo "  Node versions: $NODE_VERSIONS"
          echo "  Skip type check: $SKIP_TYPE_CHECK"
          echo "  Upload artifacts: $UPLOAD_ARTIFACTS"
          echo "  Should publish: $SHOULD_PUBLISH"

      - name: Setup Node.js
        if: steps.config.outputs.should-publish == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_DEFAULT }}

      - name: Extract package version
        if: steps.config.outputs.should-publish == 'true'
        id: version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "package-version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          
          # Check if prerelease (contains alpha, beta, rc, dev)
          if [[ "$PACKAGE_VERSION" =~ -(alpha|beta|rc|dev) ]]; then
            IS_PRERELEASE="true"
          else
            IS_PRERELEASE="false"
          fi
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          echo "üì¶ Package version: $PACKAGE_VERSION"
          echo "üè∑Ô∏è  Is prerelease: $IS_PRERELEASE"

      - name: Validate package.json
        run: |
          if [ ! -f "package.json" ]; then
            echo "‚ùå package.json not found"
            exit 1
          fi
          
          # Extract and validate package info
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          echo "‚úÖ Package validation passed"
          echo "  Name: $PACKAGE_NAME"
          echo "  Version: $PACKAGE_VERSION"

  # ==========================================================================
  # JOB 2: Type Check (Optional)
  # ==========================================================================
  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    needs: [setup]
    if: needs.setup.outputs.skip-type-check == 'false'
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_DEFAULT }}
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          pnpm install --frozen-lockfile --prefer-offline
          echo "‚úÖ Dependencies installed"

      - name: Run type check
        run: |
          echo "üîç Running TypeScript type check..."
          pnpm type-check
          echo "‚úÖ Type check passed"

  # ==========================================================================
  # JOB 3: Build Package (Matrix)
  # ==========================================================================
  build:
    name: Build (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: [setup, type-check]
    if: always() && (needs.type-check.result == 'success' || needs.type-check.result == 'skipped')
    timeout-minutes: 10
    
    strategy:
      fail-fast: false
      matrix:
        node-version: ${{ fromJSON(needs.setup.outputs.node-versions) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Cache build output
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_OUTPUT_DIR }}
          key: build-${{ runner.os }}-node${{ matrix.node-version }}-${{ hashFiles('src/**', 'package.json', 'tsconfig*.json') }}
          restore-keys: |
            build-${{ runner.os }}-node${{ matrix.node-version }}-
            build-${{ runner.os }}-

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies with pnpm..."
          pnpm install --frozen-lockfile --prefer-offline
          echo "‚úÖ Dependencies installed successfully"

      - name: Build package
        id: build
        run: |
          echo "üî® Building package..."
          echo "  Node.js: $(node --version)"
          echo "  pnpm: $(pnpm --version)"
          echo "  TypeScript: $(pnpm list typescript --depth=0 | grep typescript)"
          echo ""
          
          # Run build
          pnpm build
          
          echo ""
          echo "‚úÖ Build completed successfully"

      - name: Verify build output
        run: |
          echo "üîç Verifying build output..."
          
          # Check dist directory exists
          if [ ! -d "${{ env.BUILD_OUTPUT_DIR }}" ]; then
            echo "‚ùå Build output directory not found: ${{ env.BUILD_OUTPUT_DIR }}"
            exit 1
          fi
          
          # Check essential files
          ESSENTIAL_FILES=("index.js" "index.d.ts" "exporter.js" "exporter.d.ts")
          MISSING_FILES=()
          
          for file in "${ESSENTIAL_FILES[@]}"; do
            if [ ! -f "${{ env.BUILD_OUTPUT_DIR }}/$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è  Warning: Some expected files are missing:"
            printf '  - %s\n' "${MISSING_FILES[@]}"
          fi
          
          # Show build output structure
          echo ""
          echo "üì¶ Build output structure:"
          ls -lah ${{ env.BUILD_OUTPUT_DIR }}/ || true
          echo ""
          
          # Count files
          JS_COUNT=$(find ${{ env.BUILD_OUTPUT_DIR }} -name "*.js" | wc -l)
          DTS_COUNT=$(find ${{ env.BUILD_OUTPUT_DIR }} -name "*.d.ts" | wc -l)
          MAP_COUNT=$(find ${{ env.BUILD_OUTPUT_DIR }} -name "*.map" | wc -l)
          
          echo "üìä Build statistics:"
          echo "  JavaScript files: $JS_COUNT"
          echo "  Type definition files: $DTS_COUNT"
          echo "  Source map files: $MAP_COUNT"
          
          # Calculate total size
          TOTAL_SIZE=$(du -sh ${{ env.BUILD_OUTPUT_DIR }} | cut -f1)
          echo "  Total size: $TOTAL_SIZE"
          echo ""
          
          echo "‚úÖ Build verification passed"

      - name: Test CLI executable
        run: |
          echo "üß™ Testing CLI executable..."
          
          if [ ! -f "bin/conflu.js" ]; then
            echo "‚ùå CLI executable not found: bin/conflu.js"
            exit 1
          fi
          
          # Test --version
          echo "Testing: node bin/conflu.js --version"
          node bin/conflu.js --version || {
            echo "‚ùå CLI version command failed"
            exit 1
          }
          
          # Test --help
          echo "Testing: node bin/conflu.js --help"
          node bin/conflu.js --help > /dev/null || {
            echo "‚ùå CLI help command failed"
            exit 1
          }
          
          echo "‚úÖ CLI executable works correctly"

      - name: Upload build artifacts
        if: needs.setup.outputs.upload-artifacts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME_PREFIX }}-node${{ matrix.node-version }}-${{ github.sha }}
          path: |
            ${{ env.BUILD_OUTPUT_DIR }}/
            bin/
            package.json
            README.md
            LICENSE
          retention-days: 7
          compression-level: 6

      - name: Build summary
        if: always()
        run: |
          echo "## üì¶ Build Summary (Node ${{ matrix.node-version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "‚úÖ **Status:** Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status:** Build failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js version: ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # JOB 4: Verification (Optional - only on default Node version)
  # ==========================================================================
  verify:
    name: Integration Verification
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: contains(needs.setup.outputs.node-versions, '20')
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_DEFAULT }}
          cache: 'pnpm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME_PREFIX }}-node20-${{ github.sha }}
          path: .

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Verify package structure
        run: |
          echo "üîç Verifying package structure..."
          
          # Check package.json exports
          node -e "
            const pkg = require('./package.json');
            console.log('Package name:', pkg.name);
            console.log('Package version:', pkg.version);
            console.log('Main entry:', pkg.main);
            console.log('Types entry:', pkg.types);
            console.log('Bin entry:', pkg.bin);
          "
          
          echo "‚úÖ Package structure verified"

      - name: Test library imports
        run: |
          echo "üß™ Testing library imports..."
          
          node -e "
            const path = require('path');
            const fs = require('fs');
            
            // Test main entry point exists
            const mainPath = path.resolve('./dist/index.js');
            if (!fs.existsSync(mainPath)) {
              console.error('‚ùå Main entry point not found:', mainPath);
              process.exit(1);
            }
            
            // Test types entry point exists
            const typesPath = path.resolve('./dist/index.d.ts');
            if (!fs.existsSync(typesPath)) {
              console.error('‚ùå Types entry point not found:', typesPath);
              process.exit(1);
            }
            
            console.log('‚úÖ Library entry points verified');
          "

      - name: Verification summary
        run: |
          echo "## ‚úÖ Verification Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All package structure and imports verified successfully." >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # JOB 5: Publish to npm
  # ==========================================================================
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [setup, build, verify]
    if: needs.setup.outputs.should-publish == 'true'
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js for npm
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_DEFAULT }}
          registry-url: ${{ env.NPM_REGISTRY }}
          cache: 'pnpm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME_PREFIX }}-node${{ env.NODE_VERSION_DEFAULT }}-${{ github.sha }}
          path: .

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          pnpm install --frozen-lockfile --prefer-offline

      - name: Build package
        run: |
          echo "üî® Building package..."
          pnpm build

      - name: Publish to npm
        id: npm-publish
        run: |
          echo "üì¶ Publishing to npm..."
          echo "  Package: $(node -p "require('./package.json').name")"
          echo "  Version: $(node -p "require('./package.json').version")"
          echo "  Registry: ${{ env.NPM_REGISTRY }}"
          
          # Publish with provenance (npm 9+)
          pnpm publish --no-git-checks --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

      - name: Publish result
        run: |
          if [ "${{ steps.npm-publish.outcome }}" == "success" ]; then
            echo "## ‚úÖ npm Publish Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Package:** conflu-exporter" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** ${{ needs.setup.outputs.package-version }}" >> $GITHUB_STEP_SUMMARY
            echo "**Registry:** npm" >> $GITHUB_STEP_SUMMARY
            echo "**URL:** https://www.npmjs.com/package/conflu-exporter" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ Successfully published to npm"
          else
            echo "## ‚ö†Ô∏è npm Publish Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This might be expected if the version already exists." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è npm publish failed or version already exists"
          fi

  # ==========================================================================
  # JOB 6: Publish to GitHub Packages
  # ==========================================================================
  publish-github:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest
    needs: [setup, build, verify]
    if: needs.setup.outputs.should-publish == 'true'
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_DEFAULT }}
          registry-url: ${{ env.GITHUB_REGISTRY }}
          scope: '@${{ github.repository_owner }}'
          cache: 'pnpm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME_PREFIX }}-node${{ env.NODE_VERSION_DEFAULT }}-${{ github.sha }}
          path: .

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          pnpm install --frozen-lockfile --prefer-offline

      - name: Build package
        run: |
          echo "üî® Building package..."
          pnpm build

      - name: Prepare package for GitHub Packages
        run: |
          echo "üîß Preparing package.json for GitHub Packages..."
          
          node -e "
            const fs = require('fs');
            const pkg = require('./package.json');
            
            // Add GitHub Packages configuration
            pkg.name = '@${{ github.repository_owner }}/conflu-exporter';
            pkg.publishConfig = {
              registry: '${{ env.GITHUB_REGISTRY }}',
              access: 'public'
            };
            
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            
            console.log('‚úÖ Package prepared for GitHub Packages');
            console.log('   Name:', pkg.name);
            console.log('   Version:', pkg.version);
          "

      - name: Publish to GitHub Packages
        id: github-publish
        run: |
          echo "üì¶ Publishing to GitHub Packages..."
          echo "  Package: @${{ github.repository_owner }}/conflu-exporter"
          echo "  Version: ${{ needs.setup.outputs.package-version }}"
          echo "  Registry: ${{ env.GITHUB_REGISTRY }}"
          
          pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Publish result
        run: |
          if [ "${{ steps.github-publish.outcome }}" == "success" ]; then
            echo "## ‚úÖ GitHub Packages Publish Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Package:** @${{ github.repository_owner }}/conflu-exporter" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** ${{ needs.setup.outputs.package-version }}" >> $GITHUB_STEP_SUMMARY
            echo "**Registry:** GitHub Packages" >> $GITHUB_STEP_SUMMARY
            echo "**URL:** https://github.com/${{ github.repository_owner }}?tab=packages" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ Successfully published to GitHub Packages"
          else
            echo "## ‚ö†Ô∏è GitHub Packages Publish Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This might be expected if the version already exists." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è GitHub Packages publish failed or version already exists"
          fi

  # ==========================================================================
  # JOB 7: Create GitHub Release (only for tags)
  # ==========================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [setup, build, verify, publish-npm, publish-github]
    if: needs.setup.outputs.should-publish == 'true' && startsWith(github.ref, 'refs/tags/v')
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ needs.setup.outputs.package-version }}
          body: |
            ## üöÄ Release v${{ needs.setup.outputs.package-version }}
            
            ### üì¶ Installation
            ```bash
            npm install -g conflu-exporter@${{ needs.setup.outputs.package-version }}
            ```
            
            ### üìù Changes
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/v${{ needs.setup.outputs.package-version }}/CHANGELOG.md) for detailed changes.
            
            ### üîó Links
            - **npm:** https://www.npmjs.com/package/conflu-exporter
            - **GitHub Packages:** https://github.com/${{ github.repository_owner }}?tab=packages
          draft: false
          prerelease: ${{ needs.setup.outputs.is-prerelease == 'true' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## ‚úÖ GitHub Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.setup.outputs.package-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Prerelease:** ${{ needs.setup.outputs.is-prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://github.com/${{ github.repository }}/releases/tag/v${{ needs.setup.outputs.package-version }}" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # JOB 8: Final Summary
  # ==========================================================================
  summary:
    name: Final Summary
    runs-on: ubuntu-latest
    needs: [setup, type-check, build, verify, publish-npm, publish-github, create-release]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# üöÄ Build Package Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## üìã Workflow Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Node versions:** ${{ needs.setup.outputs.node-versions }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## üìä Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Setup
          if [ "${{ needs.setup.result }}" == "success" ]; then
            echo "‚úÖ **Setup & Validate:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Setup & Validate:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Type Check
          if [ "${{ needs.type-check.result }}" == "success" ]; then
            echo "‚úÖ **Type Check:** Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.type-check.result }}" == "skipped" ]; then
            echo "‚è≠Ô∏è  **Type Check:** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Type Check:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Build
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "‚úÖ **Build:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Build:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Verify
          if [ "${{ needs.verify.result }}" == "success" ]; then
            echo "‚úÖ **Verification:** Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.verify.result }}" == "skipped" ]; then
            echo "‚è≠Ô∏è  **Verification:** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Verification:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Publish npm
          if [ "${{ needs.publish-npm.result }}" == "success" ]; then
            echo "‚úÖ **Publish npm:** Success" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.publish-npm.result }}" == "skipped" ]; then
            echo "‚è≠Ô∏è  **Publish npm:** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è  **Publish npm:** Failed (may already exist)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Publish GitHub
          if [ "${{ needs.publish-github.result }}" == "success" ]; then
            echo "‚úÖ **Publish GitHub Packages:** Success" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.publish-github.result }}" == "skipped" ]; then
            echo "‚è≠Ô∏è  **Publish GitHub Packages:** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è  **Publish GitHub Packages:** Failed (may already exist)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # GitHub Release
          if [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "‚úÖ **GitHub Release:** Created" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.create-release.result }}" == "skipped" ]; then
            echo "‚è≠Ô∏è  **GitHub Release:** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **GitHub Release:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "## ‚úÖ Overall Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ needs.setup.outputs.should-publish }}" == "true" ]; then
              echo "### üì¶ Build & Publish Complete" >> $GITHUB_STEP_SUMMARY
              echo "The package has been built and published successfully." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              if [ "${{ needs.publish-npm.result }}" == "success" ]; then
                echo "- **npm:** https://www.npmjs.com/package/conflu-exporter" >> $GITHUB_STEP_SUMMARY
              fi
              
              if [ "${{ needs.publish-github.result }}" == "success" ]; then
                echo "- **GitHub Packages:** https://github.com/${{ github.repository_owner }}?tab=packages" >> $GITHUB_STEP_SUMMARY
              fi
              
              if [ "${{ needs.create-release.result }}" == "success" ]; then
                echo "- **GitHub Release:** https://github.com/${{ github.repository }}/releases/tag/v${{ needs.setup.outputs.package-version }}" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "### ‚úÖ Build Complete" >> $GITHUB_STEP_SUMMARY
              echo "The package has been built successfully and is ready to use." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## ‚ùå Overall Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The build failed. Please check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "‚ùå Build failed"
            exit 1
          fi
          
          echo "‚úÖ All jobs completed successfully"

